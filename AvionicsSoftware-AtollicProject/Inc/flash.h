#ifndef FLASH_H
#define FLASH_H
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// UMSATS 2018-2020
//
// Repository:
//  UMSATS/Avionics-2019
//
// File Description:
//  Header file for the flash memory interface.
//
// History
// 2019-03-28 by Joseph Howarth
// - Created.
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// INCLUDES
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

#include "hardwareDefs.h"
#include "stm32f4xx_hal.h"
#include "SPI.h"

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// DEFINITIONS AND MACROS
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

//Commands

#define		READ_ID_COMMAND			0x9F
#define 	WE_COMMAND				0x06		//Write Enable
#define		PP_COMMAND				0x02		//Page Program Command (write)
#define		READ_COMMAND			0x03

//Constants
#define		MANUFACTURER_ID			0x01
#define		DEVICE_ID_MSB			0x02
#define		DEVICE_ID_LSB			0x16

#define 	HIGH_BYTE_MASK_24B		0x00FF0000
#define		MID_BYTE_MASK_24B		0x0000FF00
#define 	LOW_BYTE_MASK_24B		0x000000FF
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// ENUMS AND ENUM TYPEDEFS
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

typedef enum {FLASH_ERROR,FLASH_OK} FlashStatus_t;

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// STRUCTS AND STRUCT TYPEDEFS
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

typedef struct {

	SPI_HandleTypeDef hspi;


} FlashStruct_t;
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// TYPEDEFS
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//-------------------------------------------------------------------------------------------------------------------------------------------------------------


//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION PROTOTYPES
//-------------------------------------------------------------------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// Description:
//  This function sets up the flash memory.
//  Right now, this consists of setting up the SPI interface and
//	checking the ID of the flash. We could also check to make sure memory is not full etc.
//
// Returns:
//  Returns FLASH_OK if the setup is successful, HAL_ERROR otherwise.
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
FlashStatus_t		initialize_flash(FlashStruct_t * flash);


//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// Description:
//  This function reads the manufacturer and device IDs of the flash memory.
//	The values are checked against the correct values.
//
// Returns:
//  Returns FLASH_OK if the IDs match and FLASH_ERROR if they do not match.
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
FlashStatus_t		check_flash_id(FlashStruct_t * flash);

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// Description:
//  This writes up to 256 bytes (one page) to a specified location in the flash memory.
//	The address should be 3 bytes long (0x000000 to 0x7FFFFF).
//	If the LSB of the address is not all 0, then data written past the page will wrap around!
//
//
// Returns:
//  Returns nothing
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
void	program_page(FlashStruct_t * flash,uint32_t address,uint8_t * data_buffer,uint8_t num_bytes);


//-------------------------------------------------------------------------------------------------------------------------------------------------------------
// Description:
//  This reads from a specified location in the flash memory.
//	The whole memory array may be read using a single read command.
//
//
// Returns:
//  Returns nothing
//-------------------------------------------------------------------------------------------------------------------------------------------------------------
void 	read_page(FlashStruct_t * flash,uint32_t address,uint8_t * data_buffer,uint8_t num_bytes);


#endif // TEMPLATE_H
